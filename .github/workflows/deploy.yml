# 工作流名称：显示在 GitHub Actions 界面
name: Deploy Vite React to GitHub Pages

# 触发条件定义
on:
  # 当代码推送到 main 分支时触发
  push:
    branches: [ main ]
  # 允许在 GitHub 界面上手动触发工作流（有"Run workflow"按钮）
  workflow_dispatch:

# 权限设置 - 这个部分很重要，决定了 Actions 能做什么
permissions:
  # contents: write - 允许写入仓库内容（这里主要是为了上传构建产物）
  contents: write
  # pages: write - 允许操作 GitHub Pages（部署页面）
  pages: write
  # id-token: write - 允许写入身份令牌（用于 OIDC 身份验证）
  id-token: write

# 环境变量定义
env:
  # 构建输出目录（Vite 默认构建到 dist 目录，与 create-react-app 的 build 不同）
  BUILD_DIR: dist
  
  # 注释掉的示例：如果使用自定义基础路径
  # 例如仓库名是 my-repo，访问地址会是 username.github.io/my-repo/
  # BASE_PATH: /${{ github.event.repository.name }}/

# 定义任务（jobs）- 这里有两个任务：build 和 deploy
jobs:
  # 第一个任务：构建 Vite 项目
  build:
    # 任务显示名称
    name: Build Vite Project
    # 运行环境：使用最新版 Ubuntu
    runs-on: ubuntu-latest
    
    # 任务的具体步骤
    steps:
    # 第一步：检出代码
    - name: Checkout repository
      # 使用 GitHub 官方的 checkout action（v4版本）
      uses: actions/checkout@v4
      with:
        # 获取完整的 git 历史记录（默认只获取最近一次 commit）
        # 深度为 0 表示获取所有历史
        fetch-depth: 0
    
    # 第二步：设置 Node.js 环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        # 指定 Node.js 版本为 20.x
        node-version: '20.x'
        # 启用 npm 缓存，加快后续的依赖安装
        # 会缓存 node_modules 目录
        cache: 'npm'
    
    # 第三步：安装项目依赖
    - name: Install dependencies
      # 执行 shell 命令
      run: npm ci
      # npm ci 与 npm install 的区别：
      # - ci 表示 "clean install"，会删除现有的 node_modules
      # - 严格根据 package-lock.json 安装，确保环境一致
      # - 安装速度更快，适合 CI/CD 环境
      # - 不会修改 package-lock.json
    
    # 第四步：构建项目
    - name: Build the project
      run: npm run build
      env:
        # 设置环境变量（重要！）
        # BASE_URL: 这是 Vite 的关键配置
        # 当部署到 GitHub Pages 的子路径时（如 username.github.io/repo-name）
        # 需要设置这个基础路径，否则静态资源会加载失败
        # ${{ github.event.repository.name }} 获取仓库名称
        BASE_URL: /${{ github.event.repository.name }}/
        
        # 注释掉的示例：其他可能需要的环境变量
        # VITE_APP_TITLE: 'My Vite App'  # Vite 使用 VITE_ 前缀的环境变量
        # VITE_API_URL: ${{ secrets.API_URL }}  # 使用 GitHub Secrets 存储敏感信息
    
    # 第五步：创建 404.html 文件（处理 SPA 路由的关键步骤）
    - name: Create 404.html for SPA
      # 因为 Vite 构建的是单页应用（SPA），当用户直接访问一个路由时
      # GitHub Pages 会返回 404，需要复制 index.html 到 404.html
      # 这样 GitHub Pages 就会回退到 index.html，由前端路由处理
      run: |
        # 将 index.html 复制一份作为 404.html
        cp ${{ env.BUILD_DIR }}/index.html ${{ env.BUILD_DIR }}/404.html
    
    # 第六步：上传构建产物
    - name: Setup Pages
        uses: actions/configure-pages@v4
        
    - name: Upload artifact
      # 使用 GitHub Pages 专用的上传 action
      uses: actions/upload-pages-artifact@v3
      with:
        # 产物名称
        name: github-pages
        # 上传哪个目录的内容（这里是构建输出的 dist 目录）
        path: ${{ env.BUILD_DIR }}/
        # 产物保留天数（这里设置为 1 天，因为部署后就上传到 Pages 了）
        retention-days: 1

  # 第二个任务：部署到 GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # 依赖关系：必须等 build 任务完成才能执行
    needs: build
    
    # 环境配置（显示在 Actions 界面）
    environment:
      # 环境名称（会在 GitHub 仓库的 Environments 中显示）
      name: github-pages
      # 部署后的页面 URL（从 deployment 步骤的输出中获取）
      url: ${{ steps.deployment.outputs.page_url }}
    
    # 部署步骤
    steps:
    - name: Deploy to GitHub Pages
      # 步骤 ID，用于在其他地方引用这个步骤的输出
      id: deployment
      # 使用官方的部署 action
      uses: actions/deploy-pages@v4